<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <title>Gestione Clienti</title>
    <script src="../scriptComune.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        function caricamento() {
            controllaAutenticazione('Operatore');
            caricaClienti();
        }

        function tornaIndietro() {
            window.location.href = "homeOperatore.html";
        }

        function inserisciCliente() {
            const nome = document.getElementById("nome").value;
            const cognome = document.getElementById("cognome").value;
            const email = document.getElementById("email").value;
            const indirizzo = document.getElementById("indirizzo").value;
            const telefono = document.getElementById("telefono").value;
            const nomeAzienda = document.getElementById("nomeAzienda").value;
            const password = document.getElementById("password").value;
            const passwordHash = CryptoJS.MD5(password).toString();

            if (nome.trim() === "") {
                alert("Il nome è obbligatorio.");
                return;
            }

            if (cognome.trim() === "") {
                alert("Il cognome è obbligatorio.");
                return;
            }

            if (email.trim() === "") {
                alert("La mail è obbligatoria.");
                return;
            }

            if (password.trim() === "") {
                alert("La password è obbligatoria.");
                return;
            }

            fetch(`http://localhost:8080/gestioneClienti/inserisci?nome=${nome}&cognome=${cognome}&email=${email}&indirizzo=${indirizzo}&telefono=${telefono}&nomeAzienda=${nomeAzienda}&password=${passwordHash}`)
                .then(res => res.text())
                .then(msg => {
                    alert("Cliente inserito.");
                    document.getElementById("formCliente").reset();
                    caricaClienti();
                });
        }

        function caricaClienti() {
            fetch("http://localhost:8080/gestioneClienti/tutti")
                .then(res => res.json())
                .then(clienti => {
                    const tabellaClienti = document.getElementById("tabellaClienti");

                    tabellaClienti.innerHTML = "";
                    const rigaIntestazioneClienti = document.createElement("tr");
                    const intestazioneIDCliente = document.createElement("th");
                    intestazioneIDCliente.textContent = 'ID';
                    rigaIntestazioneClienti.appendChild(intestazioneIDCliente);
                    const intestazioneNomeCliente = document.createElement("th");
                    intestazioneNomeCliente.textContent = 'Nome';
                    rigaIntestazioneClienti.appendChild(intestazioneNomeCliente);
                    const intestazioneCognomeCliente = document.createElement("th");
                    intestazioneCognomeCliente.textContent = 'Cognome';
                    rigaIntestazioneClienti.appendChild(intestazioneCognomeCliente);
                    const intestazioneEmailCliente = document.createElement("th");
                    intestazioneEmailCliente.textContent = 'Email';
                    rigaIntestazioneClienti.appendChild(intestazioneEmailCliente);
                    const intestazioneIndirizzoCliente = document.createElement("th");
                    intestazioneIndirizzoCliente.textContent = 'Indirizzo';
                    rigaIntestazioneClienti.appendChild(intestazioneIndirizzoCliente);
                    const intestazioneTelefonoCliente = document.createElement("th");
                    intestazioneTelefonoCliente.textContent = 'Telefono';
                    rigaIntestazioneClienti.appendChild(intestazioneTelefonoCliente);
                    const intestazioneNomeAziendaCliente = document.createElement("th");
                    intestazioneNomeAziendaCliente.textContent = 'Nome Azienda';
                    rigaIntestazioneClienti.appendChild(intestazioneNomeAziendaCliente);
                    const intestazioneEliminaCliente = document.createElement("th");
                    intestazioneEliminaCliente.textContent = 'Elimina';
                    rigaIntestazioneClienti.appendChild(intestazioneEliminaCliente);
                    tabellaClienti.appendChild(rigaIntestazioneClienti);

                    clienti.forEach(cliente => {
                        const rigaCliente = document.createElement("tr");

                        const idCellCliente = document.createElement("td");
                        idCellCliente.textContent = cliente.id;
                        rigaCliente.appendChild(idCellCliente);

                        const nomeCellCliente = document.createElement("td");
                        nomeCellCliente.textContent = cliente.nome;
                        rigaCliente.appendChild(nomeCellCliente);

                        const cognomeCellCliente = document.createElement("td");
                        cognomeCellCliente.textContent = cliente.cognome;
                        rigaCliente.appendChild(cognomeCellCliente);

                        const emailCellCliente = document.createElement("td");
                        emailCellCliente.textContent = cliente.email;
                        rigaCliente.appendChild(emailCellCliente);

                        const indirizzoCellCliente = document.createElement("td");
                        indirizzoCellCliente.textContent = cliente.indirizzo;
                        rigaCliente.appendChild(indirizzoCellCliente);

                        const telefonoCellCliente = document.createElement("td");
                        telefonoCellCliente.textContent = cliente.telefono;
                        rigaCliente.appendChild(telefonoCellCliente);

                        const nomeAziendaCellCliente = document.createElement("td");
                        nomeAziendaCellCliente.textContent = cliente.nomeAzienda;
                        rigaCliente.appendChild(nomeAziendaCellCliente);

                        const eliminaCellCliente = document.createElement("td");
                        const eliminaBtnCliente = document.createElement("button");
                        eliminaBtnCliente.textContent = "Elimina";
                        eliminaBtnCliente.addEventListener("click", () => eliminaCliente(cliente.id));
                        eliminaCellCliente.appendChild(eliminaBtnCliente);
                        rigaCliente.appendChild(eliminaCellCliente);

                        rigaCliente.append(idCellCliente, nomeCellCliente, cognomeCellCliente, emailCellCliente, indirizzoCellCliente, telefonoCellCliente, nomeAziendaCellCliente, eliminaCellCliente);
                        tabellaClienti.appendChild(rigaCliente);
                    });
                });
        }

        function eliminaCliente(id) {
            if (confirm("Sei sicuro di voler eliminare il cliente?")) {
                fetch(`http://localhost:8080/gestioneClienti/elimina?id=${id}`)
                    .then(res => res.text())
                    .then(() => {
                        alert("Cliente eliminato.");
                        caricaClienti();
                    });
            }
        }
    </script>
</head>

<body onload="caricamento()">
    <h1>Gestione Clienti</h1>
    <button onclick="tornaIndietro()">Torna home</button>

    <h2>Inserisci Nuovo Cliente</h2>
    <form id="formCliente">
        Nome: <input type="text" id="nome" required><br>
        Cognome: <input type="text" id="cognome" required><br>
        Email: <input type="email" id="email" required><br>
        Indirizzo: <input type="text" id="indirizzo"><br>
        Telefono: <input type="tel" id="telefono"><br>
        Nome Azienda: <input type="text" id="nomeAzienda"><br>
        Password: <input type="password" id="password" required><br>
        <button type="submit" onclick="inserisciCliente()">Inserisci</button>
    </form>

    <h2>Lista Clienti</h2>
    <table id="tabellaClienti"></table>
</body>

</html>